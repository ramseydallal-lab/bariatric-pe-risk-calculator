<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PE Risk Calculator - 30-Day Post-Discharge Pulmonary Embolism Risk After Bariatric Surgery">
    <title>PE Risk Calculator - Jefferson Health</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0066cc 0%, #004999 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .version {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .model-hash {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            opacity: 0.8;
            margin-top: 3px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e8e8e8;
            color: #333;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #0066cc;
            color: #0066cc;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .disclaimer {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .disclaimer h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .disclaimer p {
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .disclaimer-toggle {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            text-decoration: underline;
            font-size: 13px;
            padding: 0;
            margin-top: 5px;
        }

        .full-disclaimers {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0ad4e;
        }

        .full-disclaimers.show {
            display: block;
        }

        .full-disclaimers h4 {
            color: #856404;
            font-size: 14px;
            margin-top: 12px;
            margin-bottom: 6px;
        }

        .full-disclaimers ul {
            margin-left: 20px;
            color: #856404;
            font-size: 13px;
        }

        .full-disclaimers li {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .reference-marker {
            color: #0066cc;
            font-weight: bold;
            font-size: 12px;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        button {
            background: linear-gradient(135deg, #0066cc 0%, #004999 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,102,204,0.3);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .risk-value {
            font-size: 48px;
            font-weight: bold;
            color: #0066cc;
            text-align: center;
            margin: 20px 0;
            user-select: none;
            position: relative;
        }

        .risk-value::after {
            content: 'Decision support estimate';
            font-size: 11px;
            color: #999;
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .risk-category {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 18px;
            margin: 20px 0;
        }

        .risk-low { background: #d4edda; color: #155724; }
        .risk-moderate { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        .risk-very-high { background: #d6002a; color: white; }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box h4 {
            color: #004999;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p, .info-box ul {
            color: #004999;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 8px;
        }

        .reassessment-box {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
        }

        .reassessment-box h4 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .reassessment-box ul {
            margin-left: 20px;
            color: #856404;
        }

        .reassessment-box li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f1f1f1;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .frequency {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin: 15px 0;
        }

        .footer {
            background: #f8f9fa;
            border-top: 2px solid #ddd;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        .footer strong {
            color: #d6002a;
        }

        .error-banner {
            background: #d6002a;
            color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
            font-weight: 600;
            display: none;
        }

        .error-banner.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .tab {
                font-size: 12px;
                padding: 12px 8px;
            }
            
            .tab-content {
                padding: 20px;
            }

            .risk-value {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="text-align: center; margin-bottom: 10px;">
                <img src="./jefferson-banner.png" alt="Jefferson Health" style="max-width: 900px; width: 90%; height: auto; display: block; margin: 0 auto;">
            </div>
            <h1>PE Risk Calculator</h1>
            <p>30-Day Post-Discharge Pulmonary Embolism Risk After Bariatric Surgery</p>
            <p class="version">Version 2026-02-03 | Categorical Model | MBSAQIP 2020-2024</p>
            <p class="model-hash">Model: MBSAQIP-2020-2024-PE-CAT2 | SHA256: 7a3f8b2c</p>
        </div>

        <div class="error-banner" id="error-banner"></div>

        <div class="tabs">
            <button class="tab active" data-tab="discharge">At Discharge</button>
            <button class="tab" data-tab="ed">After ED Visit</button>
            <button class="tab" data-tab="complication">After Major Complication</button>
        </div>

        <!-- TAB 1: AT DISCHARGE -->
        <div class="tab-content active" id="discharge">
            <div class="disclaimer">
                <h3>‚ö†Ô∏è Clinical Decision Support Tool</h3>
                <p><strong>This calculator provides risk estimates for CLINICAL DECISION SUPPORT only.</strong> It is NOT a substitute for clinical judgment and does NOT prescribe treatment. All clinical decisions must incorporate individual patient factors, contraindications, bleeding risk, and clinical context.</p>
                <p><strong>Data Source:</strong> MBSAQIP participating centers, 2020-2024. <strong>Outcome:</strong> Post-discharge pulmonary embolism (PE) within 30 days of bariatric surgery. <strong>Model:</strong> Logistic regression with categorical bins (not FDA-cleared).</p>
                <button type="button" class="disclaimer-toggle" onclick="toggleDisclaimers(event,'discharge')">Show full disclaimers ‚ñº</button>
                
                <div class="full-disclaimers" id="discharge-disclaimers">
                    <h4>Model Scope & Population</h4>
                    <ul>
                        <li>Data derived from MBSAQIP participating centers (2020-2024)</li>
                        <li>Includes primary and revisional bariatric surgery procedures</li>
                        <li>Estimates apply at population level; individual patient risk may vary</li>
                    </ul>
                    
                    <h4>Outcome Definition</h4>
                    <ul>
                        <li><strong>PE-specific endpoint:</strong> This model predicts isolated pulmonary embolism (PE), NOT composite venous thromboembolism (VTE = DVT + PE)</li>
                        <li>Absolute risk values are NOT directly comparable to prior VTE-composite thresholds</li>
                        <li>PE events captured within 30 days post-discharge per MBSAQIP definitions</li>
                    </ul>
                    
                    <h4>Risk Thresholds & Interpretation</h4>
                    <ul>
                        <li><strong>Thresholds are data-driven</strong> based on independent validation performance</li>
                        <li>Selected to balance: (1) Specificity (minimize false positives), (2) Treatment volume feasibility, (3) Risk enrichment in high-risk groups</li>
                        <li>These are NOT prescriptive cutoffs‚Äîclinical action must consider individual bleeding risk and context</li>
                    </ul>
                    
                    <h4>Temporal Considerations</h4>
                    <ul>
                        <li>Risk estimates apply to 30-day post-discharge window</li>
                        <li>At-discharge estimates assume uncomplicated inpatient course</li>
                        <li><strong>Dynamic reassessment required</strong> when post-discharge events occur (see tabs 2-3)</li>
                    </ul>
                    
                    <h4>Modeling & Statistical Limitations</h4>
                    <ul>
                        <li>Logistic regression with categorical bins (reference categories indicated by *)</li>
                        <li>Model uncertainty exists‚Äîpoint estimates should be interpreted as ranges</li>
                        <li>Calibration assessed at population level; individual predictions have uncertainty</li>
                        <li>External validation ongoing‚Äîperformance may vary in other populations</li>
                    </ul>
                    
                    <h4>Input Handling & Categorization</h4>
                    <ul>
                        <li>Continuous variables binned into categories (see form dropdowns)</li>
                        <li>Missing data or out-of-range values not explicitly handled in this UI‚Äîclinician judgment required</li>
                        <li>Reference categories (marked *) represent baseline comparison groups</li>
                    </ul>
                    
                    <h4>Clinical Action & Treatment</h4>
                    <ul>
                        <li>Risk estimates should guide, not mandate, prophylaxis decisions</li>
                        <li>Must weigh PE risk against bleeding risk and contraindications</li>
                        <li>No universal threshold exists‚Äîinstitutional protocols and individual patient factors should guide decisions</li>
                        <li>Consider extended prophylaxis, early follow-up, and patient education in higher-risk categories</li>
                    </ul>
                    
                    <h4>Bleeding Risk Not Modeled</h4>
                    <ul>
                        <li>This calculator does NOT estimate bleeding risk from anticoagulation</li>
                        <li>Clinicians must independently assess bleeding contraindications before prescribing prophylaxis</li>
                    </ul>
                    
                    <h4>Comparative & Baseline Context</h4>
                    <ul>
                        <li>Prior literature used ~0.4% threshold for composite VTE (DVT + PE combined)</li>
                        <li>This calculator estimates PE-only risk‚Äîabsolute values differ from VTE-composite models</li>
                        <li>Do not apply VTE-composite thresholds to PE-specific estimates without proper context</li>
                    </ul>
                    
                    <h4>Regulatory & Legal</h4>
                    <ul>
                        <li>NOT FDA-cleared or approved as a medical device</li>
                        <li>Intended for research and clinical decision support only</li>
                        <li>Clinicians retain full responsibility for treatment decisions</li>
                    </ul>
                    
                    <h4>Data Source & Responsibility</h4>
                    <ul>
                        <li>Data from MBSAQIP participating centers (2020-2024)</li>
                        <li>Estimates reflect this population; generalizability to other settings unknown</li>
                        <li>All clinical decisions remain the responsibility of the treating clinician</li>
                    </ul>
                </div>
            </div>

            <form id="risk-form">
                <div class="form-group">
                    <label>Age (years)</label>
                    <select id="age" required>
                        <option value="1">&lt;40</option>
                        <option value="2" selected>40-49 (reference)</option>
                        <option value="3">50-59</option>
                        <option value="4">60-69</option>
                        <option value="5">‚â•70</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>BMI (kg/m¬≤)</label>
                    <select id="bmi" required>
                        <option value="1">&lt;35</option>
                        <option value="2" selected>35-44.9 (reference)</option>
                        <option value="3">45-54.9</option>
                        <option value="4">55-64.9</option>
                        <option value="5">‚â•65</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Sex</label>
                    <select id="sex" required>
                        <option value="1">Male (reference)</option>
                        <option value="2" selected>Female</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ASA Class</label>
                   <select id="asa" required>
                      <option value="1" selected>ASA I-II (reference)</option>
                      <option value="2">ASA III</option>
                      <option value="3">ASA IV-V</option>
                    </select>
                    <p class="input-note" style="color:#666;font-size:0.9em;margin-top:5px;">
  If ASA unknown, select ASA I-II (most common baseline)
</p>
                    </select>
                </div>

                <div class="form-group">
                    <label>Procedure Type</label>
                    <select id="procedure" required>
                        <option value="1" selected>Sleeve Gastrectomy (reference)</option>
                        <option value="2">Gastric Bypass</option>
                        <option value="3">Duodenal Switch-SADI</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>OR Time (minutes)</label>
                    <select id="or_time" required>
                        <option value="1">&lt;60</option>
                        <option value="2" selected>60-90 (reference)</option>
                        <option value="3">90-120</option>
                        <option value="4">120-150</option>
                        <option value="5">‚â•150</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Length of Stay (days)</label>
                    <select id="los" required>
                        <option value="0" selected>0-1 (reference)</option>
                        <option value="1">2</option>
                        <option value="2">3-4</option>
                        <option value="3">‚â•5</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>History of DVT</label>
                    <select id="dvt" required>
                        <option value="1" selected>No (reference)</option>
                        <option value="2">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>History of PE</label>
                    <select id="pe_history" required>
                        <option value="1" selected>No (reference)</option>
                        <option value="2">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Conversion from prior bariatric surgery</label>
                    <select id="conversion" required>
                        <option value="0" selected>No (reference)</option>
                        <option value="1">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Inpatient ICU admission</label>
                    <select id="icu" required>
                        <option value="0" selected>No (reference)</option>
                        <option value="1">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Inpatient pneumonia</label>
                    <select id="pna" required>
                        <option value="0" selected>No (reference)</option>
                        <option value="1">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Inpatient blood transfusion</label>
                    <select id="transfusion" required>
                        <option value="0" selected>No (reference)</option>
                        <option value="1">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Immunosuppression</label>
                    <select id="immunosupp" required>
                        <option value="0" selected>No (reference)</option>
                        <option value="1">Yes</option>
                    </select>
                </div>

                <button type="submit">Calculate Risk</button>
            </form>

            <div class="results" id="results">
                <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Risk Assessment Results</h2>
                
                <div class="risk-value" id="risk-value"></div>
                <div class="frequency" id="frequency"></div>
                <div class="risk-category" id="risk-category"></div>

                <div class="info-box">
                    <h4>Risk Category Definitions (PE-Specific)</h4>
                    <ul>
                        <li><strong>Low Risk (&lt;0.20%):</strong> PE risk substantially below threshold for routine extended prophylaxis. Standard perioperative care; discharge education about warning signs.</li>
                        <li><strong>Moderate Risk (0.20-0.39%):</strong> PE risk in intermediate range. Consider patient-specific factors (prior VTE, immobility, obesity severity, bleeding risk). May warrant closer follow-up or selective prophylaxis.</li>
                        <li><strong>High Risk (0.40-0.79%):</strong> PE risk above actionable threshold. Strong consideration for extended prophylaxis unless contraindications exist. Early follow-up recommended.</li>
                        <li><strong>Very High Risk (‚â•0.80%):</strong> Highest PE risk tier with substantial risk enrichment. Extended prophylaxis strongly recommended unless bleeding risk prohibits. Close monitoring and patient education essential.</li>
                    </ul>
                </div>

                <div class="reassessment-box">
                    <h4>‚ö†Ô∏è Dynamic Reassessment Required</h4>
                    <p style="margin-bottom: 10px;"><strong>Re-evaluate PE risk if any post-discharge event occurs:</strong></p>
                    <ul>
                        <li><strong>Emergency department visit</strong> (any reason‚Äîdehydration, pain, nausea, fever)</li>
                        <li><strong>Readmission or prolonged hospitalization</strong></li>
                        <li><strong>Major complication</strong> (anastomotic leak, bleeding, infection, organ injury)</li>
                        <li><strong>Clinical deterioration</strong> requiring intervention or ICU admission</li>
                        <li><strong>New immobility</strong> or prolonged bedrest</li>
                    </ul>
                    <p style="margin-top: 10px; font-style: italic;">Use Tabs 2-3 to assess elevated risk in these scenarios. Post-discharge events significantly increase PE risk beyond at-discharge estimates.</p>
                </div>

                <div class="info-box">
                    <h4>Interpretation & Context</h4>
                    <p><strong>This model predicts pulmonary embolism (PE) only‚Äînot composite VTE (DVT + PE).</strong></p>
                    <p style="margin-top: 10px;">Risk thresholds are derived from independent validation data balancing specificity, treatment volume, and risk enrichment.</p>
                    <p style="margin-top: 10px;"><strong>Clinical action:</strong> These estimates are decision-support tools, not prescriptive. Prophylaxis decisions must integrate individual bleeding risk, contraindications, institutional protocols, and clinical judgment.</p>
                </div>

                <button type="button" onclick="toggleDebug(event)" style="margin-top: 20px; background: #6c757d;">Show Debug Output</button>
                <div class="debug-panel" id="debug-panel"></div>
            </div>
        </div>

        <!-- TAB 2: AFTER ED VISIT - REORGANIZED PER TABLE 4 -->
        <div class="tab-content" id="ed">
            <div class="disclaimer">
                <h3>‚ö†Ô∏è Event-Triggered Thromboprophylaxis Assessment</h3>
                <p><strong>Post-discharge ED visits or IV hydration indicate transition to higher-risk state.</strong> This 3-step protocol guides reassessment and prophylaxis decisions following Table 4: Event-Triggered Thromboprophylaxis Strategy.</p>
                <button type="button" class="disclaimer-toggle" onclick="toggleDisclaimers(event,'ed')">Show full disclaimers ‚ñº</button>
                
                <div class="full-disclaimers" id="ed-disclaimers">
                    <h4>When to Use This Tab</h4>
                    <ul>
                        <li>Patient had bariatric surgery and has been discharged home</li>
                        <li>Patient presents to ED within 30 days post-discharge for ANY reason</li>
                        <li>Patient receives outpatient IV hydration within 30 days post-discharge</li>
                        <li>Common scenarios: dehydration, abdominal pain, nausea/vomiting, fever, surgical site concerns</li>
                    </ul>
                    
                    <h4>Clinical Rationale (Table 4 Framework)</h4>
                    <ul>
                        <li><strong>Step 1:</strong> ED visit or IV hydration signals clinical deterioration‚ÄîPE risk elevation independent of discharge-level classification</li>
                        <li><strong>Step 2a/2b:</strong> High-risk modifiers further stratify absolute PE risk (~1% baseline after ED encounter)</li>
                        <li><strong>Step 3:</strong> Severe adverse events require extended prophylaxis at discharge</li>
                    </ul>
                    
                    <h4>Evidence Base</h4>
                    <ul>
                        <li>Historical data shows PE risk elevation even when ED visit appears unrelated to VTE symptoms</li>
                        <li>Dehydration, immobility, infection, and physiologic stress amplify thrombotic risk</li>
                        <li>Event-triggered strategy allows dynamic risk reassessment beyond static discharge models</li>
                    </ul>
                </div>
            </div>

            <!-- STEP 1: BASELINE RECOGNITION -->
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
                <h4 style="color: #856404;">üìã STEP 1: Clinical Finding</h4>
                <p style="color: #856404; margin-bottom: 10px;"><strong>Post-discharge ED visit or outpatient IV hydration within 30 days</strong></p>
                <p style="color: #856404;"><em>Clinical Interpretation:</em> Patient has transitioned into a <strong>higher-risk postoperative state</strong>, independent of discharge-level risk classification.</p>
                <p style="color: #856404; margin-top: 10px;"><strong>‚úì Recommended Action:</strong> Reassess PE risk immediately using Steps 2 and 3 below.</p>
            </div>

            <!-- STEP 2: HIGH-RISK MODIFIERS -->
            <form id="ed-form">
                <h3 style="margin: 25px 0 15px 0; color: #333;">STEP 2: Check for High-Risk Modifiers</h3>
                <p style="margin-bottom: 15px; color: #666;">Select all patient-level risk factors that apply:</p>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="ed-history-dvt-pe" name="ed-modifier" value="history_dvt_pe">
                        <label for="ed-history-dvt-pe" style="margin: 0;">History of DVT or PE</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ed-bmi-50" name="ed-modifier" value="bmi_50">
                        <label for="ed-bmi-50" style="margin: 0;">BMI ‚â•50 kg/m¬≤</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ed-ds-bypass" name="ed-modifier" value="ds_bypass">
                        <label for="ed-ds-bypass" style="margin: 0;">Duodenal Switch (DS) or Roux-en-Y Gastric Bypass</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ed-immunosuppression" name="ed-modifier" value="immunosuppression">
                        <label for="ed-immunosuppression" style="margin: 0;">Immunosuppression (chronic steroids, biologics, transplant)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ed-age-50" name="ed-modifier" value="age_50">
                        <label for="ed-age-50" style="margin: 0;">Age ‚â•50 years</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ed-conversion" name="ed-modifier" value="conversion">
                        <label for="ed-conversion" style="margin: 0;">Conversion operation (open or laparoscopic/robotic conversion)</label>
                    </div>
                </div>

                <button type="submit" style="margin-top: 25px;">Assess Risk Modifiers (Step 2)</button>
            </form>

            <div class="results" id="ed-results">
                <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Event-Triggered Risk Assessment</h2>
                
                <!-- STEP 2a: ANY HIGH-RISK MODIFIERS PRESENT -->
                <div id="ed-step-2a" style="display: none;">
                    <div class="info-box" style="background: #f8d7da; border-left-color: #d6002a;">
                        <h4 style="color: #721c24;">‚ö†Ô∏è STEP 2a: High-Risk Modifiers Present</h4>
                        <p style="color: #721c24;" id="ed-modifier-list"></p>
                        <p style="color: #721c24; margin-top: 10px;"><em>Clinical Interpretation:</em> Additional modifiers associated with <strong>substantially increased post-discharge PE risk</strong>.</p>
                    </div>

                    <div class="reassessment-box" style="border-color: #d6002a; background: #f8d7da;">
                        <h4 style="color: #721c24;">‚úì Recommended Action (Step 2a)</h4>
                        <p style="color: #721c24; margin-bottom: 10px;"><strong>Strongly recommend extended thromboprophylaxis</strong></p>
                        <ul style="color: #721c24;">
                            <li><strong>Duration:</strong> Minimum 2-4 weeks; extend based on mobility and recovery</li>
                            <li><strong>Agent:</strong> Low-molecular-weight heparin (LMWH) or fondaparinux per institutional protocol</li>
                            <li><strong>Contraindications:</strong> Individualize if active bleeding, severe coagulopathy, or thrombocytopenia</li>
                            <li><strong>Monitoring:</strong> Close outpatient follow-up; educate on PE warning signs</li>
                        </ul>
                    </div>
                </div>

                <!-- STEP 2b: NO HIGH-RISK MODIFIERS -->
                <div id="ed-step-2b" style="display: none;">
                    <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
                        <h4 style="color: #856404;">STEP 2b: No Additional High-Risk Modifiers</h4>
                        <p style="color: #856404;"><em>Clinical Interpretation:</em> Absolute PE risk remains <strong>elevated (~1%)</strong> after ED or IV hydration encounter.</p>
                    </div>

                    <div class="reassessment-box" style="border-color: #ffc107; background: #fff3cd;">
                        <h4 style="color: #856404;">‚úì Recommended Action (Step 2b)</h4>
                        <p style="color: #856404; margin-bottom: 10px;"><strong>Consider extended thromboprophylaxis</strong></p>
                        <ul style="color: #856404;">
                            <li>Shared decision-making with patient regarding benefits vs. bleeding risk</li>
                            <li>Prophylaxis duration: 1-2 weeks if initiated; reassess at follow-up</li>
                            <li>Close outpatient monitoring (48-72 hours); educate on PE symptoms</li>
                            <li>Lower threshold for PE workup (D-dimer, CTA) if clinical suspicion arises</li>
                        </ul>
                    </div>
                </div>

                <!-- STEP 3: SEVERE ADVERSE EVENT CHECK -->
                <div class="info-box" style="background: #e8f4f8; border-left-color: #0066cc; margin-top: 25px;">
                    <h4 style="color: #004080;">üîç STEP 3: Severe Postoperative Adverse Event?</h4>
                    <p style="color: #004080; margin-bottom: 10px;">Does the patient have any of the following?</p>
                    <ul style="color: #004080;">
                        <li>Hospital readmission required</li>
                        <li>Reoperation for complication management</li>
                        <li>Sepsis, septic shock, or organ-space infection</li>
                        <li>ICU-level care or mechanical ventilation</li>
                        <li>Other severe complication (anastomotic leak, GI bleeding, etc.)</li>
                    </ul>
                    <p style="color: #004080; margin-top: 15px;"><strong>If YES ‚Üí Proceed to Tab 3: "After Major Complication"</strong></p>
                    <p style="color: #004080; margin-top: 10px;"><em>Clinical Interpretation:</em> Sustained physiologic stress with <strong>prolonged thrombotic risk</strong>.</p>
                    <p style="color: #004080; margin-top: 5px;"><strong>Recommended Action (Step 3):</strong> Extended thromboprophylaxis recommended at discharge (unless contraindicated).</p>
                </div>
            </div>
        </div>

        <!-- TAB 3: AFTER MAJOR COMPLICATION -->
        <div class="tab-content" id="complication">
            <div class="disclaimer">
                <h3>‚ö†Ô∏è Clinical Decision Support Tool</h3>
                <p><strong>Major complications drastically elevate PE risk.</strong> Use this assessment for patients with serious post-operative complications (anastomotic leak, bleeding, infection, organ injury). This tool does NOT replace clinical judgment.</p>
                <button type="button" class="disclaimer-toggle" onclick="toggleDisclaimers(event,'comp')">Show full disclaimers ‚ñº</button>
                
                <div class="full-disclaimers" id="comp-disclaimers">
                    <h4>When to Use This Tab</h4>
                    <ul>
                        <li>Patient had bariatric surgery and developed a major complication</li>
                        <li>Examples: anastomotic leak, GI bleeding, intra-abdominal abscess, sepsis, organ injury, wound dehiscence requiring reoperation</li>
                        <li>May occur during index hospitalization or after discharge</li>
                    </ul>
                    
                    <h4>Why Major Complications Elevate PE Risk</h4>
                    <ul>
                        <li>Systemic inflammation and hypercoagulable state</li>
                        <li>Prolonged immobility during extended hospitalization</li>
                        <li>Reoperation and additional surgical trauma</li>
                        <li>ICU-level care with central lines, mechanical ventilation, vasopressors</li>
                        <li>Historical data shows PE rates dramatically higher in complication cohorts</li>
                    </ul>
                    
                    <h4>High-Risk Indicators</h4>
                    <ul>
                        <li>Markers of severe complication burden requiring aggressive prophylaxis</li>
                        <li>Presence of ‚â•2 indicators suggests very high PE risk‚Äîextended prophylaxis strongly recommended unless contraindicated</li>
                        <li>Must balance PE risk against bleeding risk (especially with GI bleeding, coagulopathy)</li>
                    </ul>
                </div>
            </div>

            <div class="info-box" style="background: #f8d7da; border-left-color: #d6002a;">
                <h4 style="color: #721c24;">üö® Major Complication = High PE Risk</h4>
                <p style="color: #721c24;"><strong>Any major post-operative complication substantially increases PE risk.</strong></p>
                <p style="color: #721c24; margin-top: 10px;">Major complications include: anastomotic leak, GI bleeding requiring transfusion/intervention, intra-abdominal abscess/sepsis, organ injury, reoperation, prolonged ICU stay, mechanical ventilation, wound dehiscence.</p>
                <p style="color: #721c24; margin-top: 10px;"><strong>Baseline recommendation:</strong> Extended prophylaxis should be strongly considered for ALL patients with major complications unless contraindications exist.</p>
            </div>

            <form id="comp-form">
                <h3 style="margin: 25px 0 15px 0; color: #333;">Step 3: Check High-Risk Indicators</h3>
                <p style="margin-bottom: 20px; color: #666;">Select all that apply:</p>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="comp-icu-prolonged" name="comp-indicator">
                        <label for="comp-icu-prolonged" style="margin: 0;">ICU stay ‚â•3 days OR mechanical ventilation required</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="comp-reoperation" name="comp-indicator">
                        <label for="comp-reoperation" style="margin: 0;">Reoperation performed for complication management</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="comp-sepsis-shock" name="comp-indicator">
                        <label for="comp-sepsis-shock" style="margin: 0;">Sepsis, septic shock, or vasopressor requirement</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="comp-prolonged-hosp" name="comp-indicator">
                        <label for="comp-prolonged-hosp" style="margin: 0;">Hospital stay ‚â•7 days due to complication</label>
                    </div>
                </div>

                <button type="submit" style="margin-top: 25px;">Assess Complication Status</button>
            </form>

            <div class="results" id="comp-results">
                <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Major Complication Risk Assessment</h2>
                
                <div class="risk-category risk-very-high" style="background: #d6002a; color: white;">
                    ‚ö†Ô∏è VERY HIGH PE RISK - Major Complication
                </div>

                <div class="info-box" style="background: #f8d7da; border-left-color: #d6002a;">
                    <h4 style="color: #721c24;">High-Risk Indicators Present:</h4>
                    <p style="color: #721c24;" id="comp-indicator-count"></p>
                </div>

                <div class="info-box">
                    <h4>Clinical Recommendations</h4>
                    <ul id="comp-recommendations"></ul>
                </div>

                <div class="reassessment-box" style="border-color: #d6002a; background: #f8d7da;">
                    <h4 style="color: #721c24;">‚öïÔ∏è Extended Prophylaxis Guidance</h4>
                    <p style="color: #721c24; margin-bottom: 10px;"><strong>Extended prophylaxis strongly recommended unless contraindicated by:</strong></p>
                    <ul style="color: #721c24;">
                        <li>Active bleeding or high bleeding risk (especially GI bleeding)</li>
                        <li>Severe coagulopathy or thrombocytopenia</li>
                        <li>Other absolute contraindications to anticoagulation</li>
                    </ul>
                    <p style="color: #721c24; margin-top: 15px;"><strong>Duration:</strong> No universal guideline exists. Consider:</p>
                    <ul style="color: #721c24;">
                        <li>Minimum 2-4 weeks post-discharge; extend based on mobility, ongoing complications, and recovery trajectory</li>
                        <li>Continue until patient mobile and complications resolved</li>
                        <li>Institutional protocols and individual clinical context should guide duration</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>NOT FDA-CLEARED.</strong> Research and clinical decision support only.</p>
            <p style="margin-top: 10px;">This calculator does NOT constitute medical advice. Clinicians retain full responsibility for all treatment decisions.</p>
        </div>
    </div>

    <script>
    // Embedded coefficients (v2.2.1 - CORRECTED ASA coefficients)
    const COEFS = {
        "_cons": -7.359925831161669,
        "1.age_cat": -0.1707944848970168,
        "1.bmi_cat": 0.0201716215885371,
        "1.conversion_case": 0.0091934510151847,
        "1.icu_inhosp": 0.0477686778352449,
        "1.los_cat": 0.2043870040504978,
        "1.or_cat": -0.2609151064615611,
        "1.pna_inhosp": -0.4070056544061855,
        "1.transf_inhosp": 1.102089726959736,
        "2.HISTORY_DVT_cat": 0.4351823913972787,
        "2.HISTORY_PE_cat": 0.8927562968581318,
        "2.asa2": 0.0430234155584275,
        "2.final_anatomy_cat": 0.1817496402942271,
        "2.los_cat": 0.7269080224114364,
        "2.sex2": 0.0997606515772661,
        "3.age_cat": 0.1180797603346544,
        "3.asa2": -0.039161272986978,
        "3.bmi_cat": 0.2731806894556259,
        "3.final_anatomy_cat": 0.2188574422528906,
        "3.los_cat": 0.8030304480511562,
        "3.or_cat": 0.0438307784056062,
        "4.age_cat": 0.261049564886048,
        "4.bmi_cat": 0.4839104477046168,
        "4.or_cat": 0.177708561076741,
        "5.age_cat": 0.74519056789782,
        "5.bmi_cat": 0.7290282237091352,
        "5.or_cat": 0.4524747062637586,
        "immu_b": 0.4364415905257424
    };



    // Coefficient validation
    function validateCoefficient(term, description) {
        if (COEFS[term] === undefined) {
            const error = `CRITICAL ERROR: Missing coefficient for ${term} (${description})`;
            console.error(error);
            showError(error);
            throw new Error(error);
        }
        return COEFS[term];
    }

    function showError(message) {
        const banner = document.getElementById('error-banner');
        banner.textContent = '‚ö†Ô∏è ' + message;
        banner.classList.add('show');
    }

    // Tab switching
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Form submission - Tab 1
        document.getElementById('risk-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                // Clear any previous errors
                document.getElementById('error-banner').classList.remove('show');
                
                const age = parseInt(document.getElementById('age').value);
                const bmi = parseInt(document.getElementById('bmi').value);
                const sex = parseInt(document.getElementById('sex').value);
                const asa = parseInt(document.getElementById('asa').value);
                const procedure = parseInt(document.getElementById('procedure').value);
                const or_time = parseInt(document.getElementById('or_time').value);
                const los = parseInt(document.getElementById('los').value);
                const dvt = parseInt(document.getElementById('dvt').value);
                const pe_history = parseInt(document.getElementById('pe_history').value);
                const conversion = parseInt(document.getElementById('conversion').value);
                const icu = parseInt(document.getElementById('icu').value);
                const pna = parseInt(document.getElementById('pna').value);
                const transfusion = parseInt(document.getElementById('transfusion').value);
                const immunosupp = parseInt(document.getElementById('immunosupp').value);

                let lp = validateCoefficient('_cons', 'Intercept');
                let debug = [`Intercept: ${COEFS['_cons'].toFixed(6)}`];

                // Age categories (1=<40, 2=40-49 ref, 3=50-59, 4=60-69, 5=‚â•70)
                if (age === 1) {
                    const coef = validateCoefficient('1.age_cat', 'Age <40');
                    lp += coef;
                    debug.push(`Age <40: ${coef.toFixed(6)}`);
                } else if (age === 2) {
                    debug.push(`Age 40-49 (reference): 0.000000`);
                } else if (age === 3) {
                    const coef = validateCoefficient('3.age_cat', 'Age 50-59');
                    lp += coef;
                    debug.push(`Age 50-59: ${coef.toFixed(6)}`);
                } else if (age === 4) {
                    const coef = validateCoefficient('4.age_cat', 'Age 60-69');
                    lp += coef;
                    debug.push(`Age 60-69: ${coef.toFixed(6)}`);
                } else if (age === 5) {
                    const coef = validateCoefficient('5.age_cat', 'Age ‚â•70');
                    lp += coef;
                    debug.push(`Age ‚â•70: ${coef.toFixed(6)}`);
                }

                // BMI categories (1=<35, 2=35-44.9 ref, 3=45-54.9, 4=55-64.9, 5=‚â•65)
                if (bmi === 1) {
                    const coef = validateCoefficient('1.bmi_cat', 'BMI <35');
                    lp += coef;
                    debug.push(`BMI <35: ${coef.toFixed(6)}`);
                } else if (bmi === 2) {
                    debug.push(`BMI 35-44.9 (reference): 0.000000`);
                } else if (bmi === 3) {
                    const coef = validateCoefficient('3.bmi_cat', 'BMI 45-54.9');
                    lp += coef;
                    debug.push(`BMI 45-54.9: ${coef.toFixed(6)}`);
                } else if (bmi === 4) {
                    const coef = validateCoefficient('4.bmi_cat', 'BMI 55-64.9');
                    lp += coef;
                    debug.push(`BMI 55-64.9: ${coef.toFixed(6)}`);
                } else if (bmi === 5) {
                    const coef = validateCoefficient('5.bmi_cat', 'BMI ‚â•65');
                    lp += coef;
                    debug.push(`BMI ‚â•65: ${coef.toFixed(6)}`);
                }

                // Sex (1=Male ref, 2=Female)
                if (sex === 1) {
                    debug.push(`Male (reference): 0.000000`);
                } else if (sex === 2) {
                    const coef = validateCoefficient('2.sex2', 'Female');
                    lp += coef;
                    debug.push(`Female: ${coef.toFixed(6)}`);
                }

                // ASA (1=I-II ref, 2=III, 3=IV-V)
                if (asa === 1) {
                    debug.push(`ASA I-II (reference): 0.000000`);
                } else if (asa === 2) {
                    const coef = validateCoefficient('2.asa2', 'ASA III');
                    lp += coef;
                    debug.push(`ASA III: ${coef.toFixed(6)}`);
                } else if (asa === 3) {
                    const coef = validateCoefficient('3.asa2', 'ASA IV-V');
                    lp += coef;
                    debug.push(`ASA IV-V: ${coef.toFixed(6)}`);
                }

                // Procedure (1=Sleeve ref, 2=RYGB, 3=DS/SADI)
                if (procedure === 1) {
                    debug.push(`Sleeve (reference): 0.000000`);
                } else if (procedure === 2) {
                    const coef = validateCoefficient('2.final_anatomy_cat', 'RYGB');
                    lp += coef;
                    debug.push(`RYGB: ${coef.toFixed(6)}`);
                } else if (procedure === 3) {
                    const coef = validateCoefficient('3.final_anatomy_cat', 'Other');
                    lp += coef;
                    debug.push(`Other: ${coef.toFixed(6)}`);
                }

                // OR Time (1=<60, 2=60-90 ref, 3=90-120, 4=120-150, 5=‚â•150)
                if (or_time === 1) {
                    const coef = validateCoefficient('1.or_cat', 'OR <60');
                    lp += coef;
                    debug.push(`OR <60: ${coef.toFixed(6)}`);
                } else if (or_time === 2) {
                    debug.push(`OR 60-90 (reference): 0.000000`);
                } else if (or_time === 3) {
                    const coef = validateCoefficient('3.or_cat', 'OR 90-120');
                    lp += coef;
                    debug.push(`OR 90-120: ${coef.toFixed(6)}`);
                } else if (or_time === 4) {
                    const coef = validateCoefficient('4.or_cat', 'OR 120-150');
                    lp += coef;
                    debug.push(`OR 120-150: ${coef.toFixed(6)}`);
                } else if (or_time === 5) {
                    const coef = validateCoefficient('5.or_cat', 'OR ‚â•150');
                    lp += coef;
                    debug.push(`OR ‚â•150: ${coef.toFixed(6)}`);
                }

                // LOS (0=0-1 ref, 1=2, 2=3-4, 3=‚â•5)
                if (los === 0) {
                    debug.push(`LOS 0-1 (reference): 0.000000`);
                } else if (los === 1) {
                    const coef = validateCoefficient('1.los_cat', 'LOS 2');
                    lp += coef;
                    debug.push(`LOS 2: ${coef.toFixed(6)}`);
                } else if (los === 2) {
                    const coef = validateCoefficient('2.los_cat', 'LOS 3-4');
                    lp += coef;
                    debug.push(`LOS 3-4: ${coef.toFixed(6)}`);
                } else if (los === 3) {
                    const coef = validateCoefficient('3.los_cat', 'LOS ‚â•5');
                    lp += coef;
                    debug.push(`LOS ‚â•5: ${coef.toFixed(6)}`);
                }

                // DVT (1=No ref, 2=Yes)
                if (dvt === 1) {
                    // No DVT History (reference): coefficient = 0
                    debug.push(`No DVT History (reference): 0.000000`);
                } else if (dvt === 2) {
                    const coef = validateCoefficient('2.HISTORY_DVT_cat', 'History DVT');
                    lp += coef;
                    debug.push(`History DVT: ${coef.toFixed(6)}`);
                }

                // PE History (1=No ref, 2=Yes)
                if (pe_history === 1) {
                    // No PE History (reference): coefficient = 0
                    debug.push(`No PE History (reference): 0.000000`);
                } else if (pe_history === 2) {
                    const coef = validateCoefficient('2.HISTORY_PE_cat', 'History PE');
                    lp += coef;
                    debug.push(`History PE: ${coef.toFixed(6)}`);
                }

                // Conversion (0=No ref, 1=Yes)
                if (conversion === 0) {
                    // No Conversion (reference): coefficient = 0
                    debug.push(`No Conversion (reference): 0.000000`);
                } else if (conversion === 1) {
                    const coef = validateCoefficient('1.conversion_case', 'Conversion');
                    lp += coef;
                    debug.push(`Conversion: ${coef.toFixed(6)}`);
                }

                // ICU (0=No ref, 1=Yes)
                if (icu === 0) {
                    // No ICU (reference): coefficient = 0
                    debug.push(`No ICU (reference): 0.000000`);
                } else if (icu === 1) {
                    const coef = validateCoefficient('1.icu_inhosp', 'ICU');
                    lp += coef;
                    debug.push(`ICU: ${coef.toFixed(6)}`);
                }

                // Pneumonia (0=No ref, 1=Yes)
                if (pna === 0) {
                    // No Pneumonia (reference): coefficient = 0
                    debug.push(`No Pneumonia (reference): 0.000000`);
                } else if (pna === 1) {
                    const coef = validateCoefficient('1.pna_inhosp', 'Pneumonia');
                    lp += coef;
                    debug.push(`Pneumonia: ${coef.toFixed(6)}`);
                }

                // Transfusion (0=No ref, 1=Yes)
                if (transfusion === 0) {
                    // No Transfusion (reference): coefficient = 0
                    debug.push(`No Transfusion (reference): 0.000000`);
                } else if (transfusion === 1) {
                    const coef = validateCoefficient('1.transf_inhosp', 'Transfusion');
                    lp += coef;
                    debug.push(`Transfusion: ${coef.toFixed(6)}`);
                }

                // Immunosuppression (0=No, 1=Yes)
                if (immunosupp === 1) {
                    const coef = validateCoefficient('immu_b', 'Immunosuppression');
                    lp += coef;
                    debug.push(`Immunosuppression: ${coef.toFixed(6)}`);
                } else {
                    debug.push(`No Immunosuppression: 0.000000`);
                }

                debug.push(`\nLinear Predictor (LP): ${lp.toFixed(6)}`);

                // Calculate probability
                const prob = 1 / (1 + Math.exp(-lp));
                const riskPercent = (prob * 100).toFixed(2);
                
                debug.push(`Predicted Probability: ${prob.toFixed(8)}`);
                debug.push(`Risk Percentage: ${riskPercent}%`);

                // Determine category with corrected thresholds
                let category, categoryClass, categoryText;
                
                if (prob >= 0.008) { // ‚â•0.80%
                    category = 'Very High Risk';
                    categoryClass = 'risk-very-high';
                    categoryText = `Very High Risk (‚â•0.80%)`;
                } else if (prob >= 0.004) { // 0.40-0.79%
                    category = 'High Risk';
                    categoryClass = 'risk-high';
                    categoryText = `High Risk (0.40-0.79%)`;
                } else if (prob >= 0.002) { // 0.20-0.39%
                    category = 'Moderate Risk';
                    categoryClass = 'risk-moderate';
                    categoryText = `Moderate Risk (0.20-0.39%)`;
                } else { // <0.20%
                    category = 'Low Risk';
                    categoryClass = 'risk-low';
                    categoryText = `Low Risk (<0.20%)`;
                }

                // Display results
                document.getElementById('risk-value').textContent = riskPercent + '%';
                
                // Frequency display (handle rare events)
                if (prob < 0.001) {
                    document.getElementById('frequency').textContent = 'Rare event (<0.1%)';
                } else {
                    const frequency = Math.round(1 / prob);
                    document.getElementById('frequency').textContent = `(Approximately 1 in ${frequency} patients)`;
                }
                
                const categoryDiv = document.getElementById('risk-category');
                categoryDiv.textContent = categoryText;
                categoryDiv.className = 'risk-category ' + categoryClass;

                document.getElementById('debug-panel').innerHTML = '<strong>Debug Output:</strong><br>' + debug.join('<br>');
                document.getElementById('results').classList.add('show');
                
                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
            } catch (error) {
                console.error('Calculation error:', error);
                showError('Calculation failed: ' + error.message);
            }
        });

        // Form submission - Tab 2 (ED Visit) - Updated for Table 4 Step 2a/2b Logic
        document.getElementById('ed-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const modifiers = document.querySelectorAll('input[name="ed-modifier"]:checked');
            const modifierCount = modifiers.length;
            
            // Show results section
            document.getElementById('ed-results').classList.add('show');
            document.getElementById('ed-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Build modifier list text
            const modifierNames = {
                'history_dvt_pe': 'History of DVT or PE',
                'bmi_50': 'BMI ‚â•50 kg/m¬≤',
                'ds_bypass': 'DS or Gastric Bypass',
                'immunosuppression': 'Immunosuppression',
                'age_50': 'Age ‚â•50 years',
                'conversion': 'Conversion operation'
            };
            
            if (modifierCount > 0) {
                // STEP 2a: ANY high-risk modifiers present
                document.getElementById('ed-step-2a').style.display = 'block';
                document.getElementById('ed-step-2b').style.display = 'none';
                
                const modifierListText = Array.from(modifiers)
                    .map(m => modifierNames[m.value])
                    .join('; ');
                
                document.getElementById('ed-modifier-list').innerHTML = 
                    `<strong>${modifierCount} high-risk modifier(s) identified:</strong> ${modifierListText}`;
                
            } else {
                // STEP 2b: NO high-risk modifiers
                document.getElementById('ed-step-2a').style.display = 'none';
                document.getElementById('ed-step-2b').style.display = 'block';
            }
        });

        // Form submission - Tab 3 (Major Complication)
        document.getElementById('comp-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const indicators = document.querySelectorAll('input[name="comp-indicator"]:checked');
            const indicatorCount = indicators.length;
            
            document.getElementById('comp-indicator-count').textContent = 
                `${indicatorCount} high-risk indicator(s) present`;
            
            const recommendations = document.getElementById('comp-recommendations');
            let recs = [
                '<strong>Extended prophylaxis strongly recommended</strong> unless contraindicated by bleeding risk',
                'Balance PE risk against bleeding risk daily',
                'Consider hematology/vascular surgery consultation',
                'Lower threshold for PE workup if any clinical suspicion',
                'Continue prophylaxis until mobile and complications resolved (minimum 2-4 weeks post-discharge)',
                'Close outpatient follow-up with prophylaxis reinforcement'
            ];
            
            if (indicatorCount >= 2) {
                recs.unshift('<strong style="color: #d6002a;">‚ö†Ô∏è VERY HIGH RISK - Multiple severe indicators present</strong>');
                recs.push('Consider longer prophylaxis duration (4-6 weeks or until full mobility restored)');
                recs.push('Multidisciplinary discussion recommended');
            }
            
            recommendations.innerHTML = recs.map(r => `<li>${r}</li>`).join('');
            
            document.getElementById('comp-results').classList.add('show');
            document.getElementById('comp-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
    });

        function toggleDisclaimers(e, tab) {
              const disclaimers = document.getElementById(tab + '-disclaimers');
              const button = e.target;

                disclaimers.classList.toggle('show');

              button.textContent = disclaimers.classList.contains('show')
                ? 'Hide full disclaimers ‚ñ≤'
                : 'Show full disclaimers ‚ñº';
}


        function toggleDebug(e) {
              const panel = document.getElementById('debug-panel');
              const button = e.target;

              panel.classList.toggle('show');

              button.textContent = panel.classList.contains('show')
                ? 'Hide Debug Output'
                : 'Show Debug Output';
}

    </script>
</body>
</html>
